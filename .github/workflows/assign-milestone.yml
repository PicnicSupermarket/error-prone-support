name: Assign milestone to dependency PRs
on:
  pull_request:
    types:
      - labeled
permissions:
  contents: read
jobs:
  assign-milestone:
    if: >-
      github.event.label.name == 'dependencies'
      && github.event.pull_request.milestone == null
    permissions:
      contents: read
      issues: write
    runs-on: ubuntu-24.04
    steps:
      - name: Install Harden-Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          disable-sudo-and-containers: true
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
      - name: Assign first upcoming milestone
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const milestones = await github.rest.issues.listMilestones({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            if (milestones.data.length === 0) {
              core.warning('No open milestones found.');
              return;
            }

            const parts = (t) => t.split('.').map(Number);
            milestones.data.sort((a, b) => {
              const pa = parts(a.title);
              const pb = parts(b.title);
              for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
                const diff = (pa[i] || 0) - (pb[i] || 0);
                if (diff !== 0) return diff;
              }
              return 0;
            });

            const milestone = milestones.data[0];
            core.info(`Assigning milestone "${milestone.title}" to PR #${context.issue.number}.`);

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              milestone: milestone.number,
            });
